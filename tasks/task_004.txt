# Task ID: 4
# Title: Implement Real-time Voting Updates
# Status: in-progress
# Dependencies: 2, 3
# Priority: high
# Description: Set up real-time subscriptions for vote updates using Supabase Realtime.
# Details:
1. Use Supabase Realtime to subscribe to changes in the votes and user_votes tables.
2. Implement a WebSocket connection in the frontend using Supabase client.
3. Update the VoteResults component to reflect real-time changes.
4. Add animations using Framer Motion for updating vote counts and rankings.
5. Implement error handling and reconnection logic for WebSocket disconnects.
6. Optimize performance by using efficient data structures for vote counting.

# Test Strategy:
Create a test environment that simulates multiple users voting simultaneously. Verify that all clients receive updates in real-time. Test WebSocket disconnection and reconnection scenarios.

# Subtasks:
## 1. Supabase Realtime Configuration [done]
### Dependencies: None
### Description: Set up and configure Supabase Realtime service for the Picnic application
### Details:
Enable Realtime features in Supabase project settings. Configure PostgreSQL for logical replication. Set up appropriate security policies using Row Level Security (RLS) to control access to real-time data. Create necessary database tables and triggers for broadcasting changes.
<info added on 2025-05-29T02:47:50.098Z>
## Supabase Realtime Configuration ì™„ë£Œ âœ…

### 1. Supabase í´ë¼ì´ì–¸íŠ¸ Realtime í™œì„±í™”
- **íŒŒì¼**: `lib/supabase/client.ts`
- **ì„¤ì • ì¶”ê°€**:
  - `eventsPerSecond: 10` - ì´ˆë‹¹ ìµœëŒ€ ì´ë²¤íŠ¸ ìˆ˜ ì œí•œ
  - `log_level` - ê°œë°œ í™˜ê²½ì—ì„œ 'info', í”„ë¡œë•ì…˜ì—ì„œ 'error'
  - `reconnectAfterMs` - ì§€ìˆ˜ ë°±ì˜¤í”„ ì¬ì—°ê²° (1ì´ˆ~30ì´ˆ)
  - `heartbeatIntervalMs: 30000` - 30ì´ˆ í•˜íŠ¸ë¹„íŠ¸ ê°„ê²©
  - `timeout: 10000` - 10ì´ˆ ì—°ê²° íƒ€ì„ì•„ì›ƒ

### 2. íˆ¬í‘œ ì‹œìŠ¤í…œ Realtime ì„œë¹„ìŠ¤ êµ¬í˜„
- **íŒŒì¼**: `lib/supabase/realtime.ts` (ìƒˆë¡œ ìƒì„±)
- **ì£¼ìš” ê¸°ëŠ¥**:
  - `VoteRealtimeService` í´ë˜ìŠ¤ - íˆ¬í‘œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê´€ë¦¬
  - ì‹±ê¸€í†¤ íŒ¨í„´ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬
  - íˆ¬í‘œ(`vote`) ë° ì•„í‹°ìŠ¤íŠ¸ íˆ¬í‘œ(`artist_vote`) ì§€ì›
  - ìë™ ì¬ì—°ê²° ë¡œì§ (ìµœëŒ€ 5íšŒ, ì§€ìˆ˜ ë°±ì˜¤í”„)
  - ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ

### 3. ì§€ì›í•˜ëŠ” í…Œì´ë¸” ë° ì´ë²¤íŠ¸
- **íˆ¬í‘œ í…Œì´ë¸”**: `vote`, `vote_item`, `vote_pick`
- **ì•„í‹°ìŠ¤íŠ¸ íˆ¬í‘œ í…Œì´ë¸”**: `artist_vote`, `artist_vote_item`
- **ì´ë²¤íŠ¸ íƒ€ì…**:
  - `vote_updated` - íˆ¬í‘œ ì •ë³´ ì—…ë°ì´íŠ¸
  - `vote_item_updated` - íˆ¬í‘œ í•­ëª© ì—…ë°ì´íŠ¸
  - `vote_pick_created` - ìƒˆë¡œìš´ íˆ¬í‘œ ì°¸ì—¬
  - `artist_vote_updated` - ì•„í‹°ìŠ¤íŠ¸ íˆ¬í‘œ ì—…ë°ì´íŠ¸
  - `artist_vote_item_updated` - ì•„í‹°ìŠ¤íŠ¸ íˆ¬í‘œ í•­ëª© ì—…ë°ì´íŠ¸

### 4. ì˜¤ë¥˜ ì²˜ë¦¬ ë° ì¬ì—°ê²°
- **ì—°ê²° ìƒíƒœ**: `connecting`, `connected`, `disconnected`, `error`
- **ì¬ì—°ê²° ë¡œì§**: ì§€ìˆ˜ ë°±ì˜¤í”„ (1ì´ˆ, 2ì´ˆ, 4ì´ˆ, 8ì´ˆ, ìµœëŒ€ 30ì´ˆ)
- **ìµœëŒ€ ì¬ì—°ê²° ì‹œë„**: 5íšŒ
- **íƒ€ì… ì•ˆì „ì„±**: TypeScript íƒ€ì… ì •ì˜ ë° ëŸ°íƒ€ì„ ê²€ì¦

### 5. ê°œë°œì ë„êµ¬
- ê°œë°œ í™˜ê²½ì—ì„œ ìƒì„¸í•œ ë¡œê¹…
- í™œì„± êµ¬ë… ëª¨ë‹ˆí„°ë§ ë©”ì„œë“œ
- ì—°ê²° ìƒíƒœ ì¶”ì  ë° ë””ë²„ê¹… ì§€ì›
</info added on 2025-05-29T02:47:50.098Z>

## 2. Frontend WebSocket Client Implementation [done]
### Dependencies: 4.1
### Description: Implement WebSocket client in the Next.js 13+ App Router application
### Details:
Create a WebSocket client service using Supabase client library. Implement connection management within the Next.js application context. Set up event listeners for different types of real-time events. Create React hooks for components to subscribe to real-time updates.
<info added on 2025-05-29T02:51:07.621Z>
## Frontend WebSocket Client Implementation ì™„ë£Œ âœ…

### 1. React ì»¤ìŠ¤í…€ í›… êµ¬í˜„
- **íŒŒì¼**: `hooks/useVoteRealtime.ts` (ìƒˆë¡œ ìƒì„±)
- **ì£¼ìš” ê¸°ëŠ¥**:
  - `useVoteRealtime` - ë©”ì¸ ì‹¤ì‹œê°„ íˆ¬í‘œ í›…
  - `useVoteConnectionStatus` - ì—°ê²° ìƒíƒœë§Œ ì¶”ì í•˜ëŠ” ê°„ë‹¨í•œ í›…
  - `useVoteEvents` - ì´ë²¤íŠ¸ë§Œ ìˆ˜ì‹ í•˜ëŠ” í›…
  - ìë™ ì—°ê²°/í•´ì œ, ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€
  - ì´ë²¤íŠ¸ ì¹´ìš´íŒ… ë° ìƒíƒœ ì¶”ì 

### 2. ì‹¤ì‹œê°„ ìƒíƒœ í‘œì‹œ ì»´í¬ë„ŒíŠ¸
- **íŒŒì¼**: `components/client/vote/common/RealtimeStatus.tsx` (ìƒˆë¡œ ìƒì„±)
- **ì»´í¬ë„ŒíŠ¸ë“¤**:
  - `RealtimeStatus` - ê¸°ë³¸ ìƒíƒœ í‘œì‹œ ì»´í¬ë„ŒíŠ¸
  - `RealtimeIndicator` - ì»´íŒ©íŠ¸ ì¸ë””ì¼€ì´í„°
  - `RealtimeStatusPanel` - ìƒì„¸ ìƒíƒœ íŒ¨ë„
- **ê¸°ëŠ¥**:
  - ì—°ê²° ìƒíƒœë³„ ì‹œê°ì  í”¼ë“œë°± (ğŸ”„ ì—°ê²°ì¤‘, ğŸŸ¢ ì—°ê²°ë¨, âš« ì—°ê²°ì•ˆë¨, ğŸ”´ ì˜¤ë¥˜)
  - Tailwind CSS ìŠ¤íƒ€ì¼ë§
  - í™œì„± êµ¬ë… ìˆ˜ í‘œì‹œ

### 3. ì‹¤ì‹œê°„ ë°ì´í„° ê´€ë¦¬ Context
- **íŒŒì¼**: `contexts/VoteRealtimeContext.tsx` (ìƒˆë¡œ ìƒì„±)
- **ì£¼ìš” ê¸°ëŠ¥**:
  - `VoteRealtimeProvider` - ì‹¤ì‹œê°„ íˆ¬í‘œ ë°ì´í„° ê´€ë¦¬
  - `useVoteRealtimeContext` - Context ì‚¬ìš© í›…
  - `useVoteItem` - íŠ¹ì • íˆ¬í‘œ í•­ëª© ë°ì´í„° í›…
- **ìƒíƒœ ê´€ë¦¬**:
  - íˆ¬í‘œ ì •ë³´, íˆ¬í‘œ í•­ëª©, íˆ¬í‘œ ê¸°ë¡
  - ì—°ê²° ìƒíƒœ, í†µê³„, ë¡œë”©/ì˜¤ë¥˜ ìƒíƒœ
  - useReducer íŒ¨í„´ìœ¼ë¡œ ë³µì¡í•œ ìƒíƒœ ê´€ë¦¬

### 4. íƒ€ì… ì•ˆì „ì„± ë° ì˜¤ë¥˜ ì²˜ë¦¬
- **TypeScript ì™„ì „ ì§€ì›**: ëª¨ë“  ì»´í¬ë„ŒíŠ¸ì™€ í›…ì— íƒ€ì… ì •ì˜
- **ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€**: useEffect cleanup í•¨ìˆ˜ë¡œ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
- **ì˜¤ë¥˜ ê²½ê³„**: try-catch ë¸”ë¡ê³¼ ì˜¤ë¥˜ ìƒíƒœ ê´€ë¦¬
- **ê°œë°œì ë„êµ¬**: ê°œë°œ í™˜ê²½ì—ì„œ ìƒì„¸í•œ ë¡œê¹…

### 5. ì„±ëŠ¥ ìµœì í™”
- **React.memo**: ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ ë°©ì§€
- **useCallback**: í•¨ìˆ˜ ë©”ëª¨ì´ì œì´ì…˜
- **ì‹±ê¸€í†¤ íŒ¨í„´**: Realtime ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ ì¬ì‚¬ìš©
- **ì¡°ê±´ë¶€ ë Œë”ë§**: ìƒíƒœì— ë”°ë¥¸ íš¨ìœ¨ì ì¸ UI ì—…ë°ì´íŠ¸

### 6. ì‚¬ìš© ì˜ˆì‹œ
```tsx
// ê¸°ë³¸ ì‚¬ìš©ë²•
function VoteComponent({ voteId }: { voteId: number }) {
  const { isConnected, lastEvent } = useVoteRealtime({ voteId });
  
  return (
    <div>
      <RealtimeIndicator voteId={voteId} />
      {isConnected && <p>ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í™œì„±</p>}
    </div>
  );
}

// Context ì‚¬ìš©ë²•
function VoteApp({ voteId }: { voteId: number }) {
  return (
    <VoteRealtimeProvider voteId={voteId}>
      <VoteList />
      <RealtimeStatusPanel />
    </VoteRealtimeProvider>
  );
}
```
</info added on 2025-05-29T02:51:07.621Z>

## 3. VoteResults Real-time Updates Integration [pending]
### Dependencies: 4.2
### Description: Implement real-time updates for vote results in the Picnic application
### Details:
Create database triggers for vote-related tables. Implement subscription logic for vote result changes. Update UI components to reflect real-time vote changes. Ensure proper data synchronization between server and client states.

## 4. Animation Implementation for Real-time Updates [pending]
### Dependencies: 4.3
### Description: Add smooth animations for real-time data changes in the UI
### Details:
Design animation patterns for different types of updates. Implement CSS/JS animations using Tailwind CSS and potentially additional animation libraries. Ensure animations are performant and don't cause layout shifts. Create transition states for data changes.

## 5. Error Handling and Reconnection Logic [pending]
### Dependencies: 4.2
### Description: Implement robust error handling and automatic reconnection for WebSocket connections
### Details:
Create error handling strategies for different failure scenarios. Implement exponential backoff for reconnection attempts. Add user feedback mechanisms for connection status. Implement data recovery procedures after reconnection.

## 6. Performance Optimization [pending]
### Dependencies: 4.3, 4.4, 4.5
### Description: Optimize real-time feature performance for the Picnic application
### Details:
Implement efficient data structures for managing real-time state. Optimize render cycles to prevent unnecessary re-renders. Add debouncing/throttling for high-frequency updates. Monitor and optimize memory usage for long-lived connections.

## 7. Testing and Validation [pending]
### Dependencies: 4.6
### Description: Comprehensive testing of real-time features across different scenarios
### Details:
Create unit tests for WebSocket client functionality. Implement integration tests for real-time data flow. Test reconnection scenarios and error recovery. Perform load testing to ensure system stability under high concurrency. Validate proper functioning with WeChat login integration.

