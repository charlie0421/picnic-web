name: Test and Coverage

on:
  # ì„ì‹œ ë¹„í™œì„±í™” - ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥
  workflow_dispatch:
  # push:
  #   branches: [ main, production ]
  # pull_request:
  #   branches: [ main, production ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x]

    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests with coverage
      run: npm run test:ci
      
    - name: Check coverage threshold
      run: |
        echo "ğŸ” ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ ê²€ì¦ ì¤‘..."
        npm run test:coverage -- --passWithNoTests
        if [ $? -ne 0 ]; then
          echo "âŒ ì»¤ë²„ë¦¬ì§€ê°€ 80% ì„ê³„ê°’ì— ë¯¸ë‹¬í–ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“Š í˜„ì¬ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
          exit 1
        else
          echo "âœ… ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ 80%ë¥¼ ì¶©ì¡±í–ˆìŠµë‹ˆë‹¤!"
        fi
        
    - name: Generate coverage summary
      run: |
        echo "ğŸ“Š ì»¤ë²„ë¦¬ì§€ ìš”ì•½ ìƒì„± ì¤‘..."
        if [ -f coverage/coverage-summary.json ]; then
          echo "## ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          node -e "
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const total = coverage.total;
            console.log('| í•­ëª© | ì»¤ë²„ë¦¬ì§€ | ì„ê³„ê°’ | ìƒíƒœ |');
            console.log('|------|----------|--------|------|');
            console.log('| Statements | ' + total.statements.pct + '% | 80% | ' + (total.statements.pct >= 80 ? 'âœ…' : 'âŒ') + ' |');
            console.log('| Branches | ' + total.branches.pct + '% | 80% | ' + (total.branches.pct >= 80 ? 'âœ…' : 'âŒ') + ' |');
            console.log('| Functions | ' + total.functions.pct + '% | 80% | ' + (total.functions.pct >= 80 ? 'âœ…' : 'âŒ') + ' |');
            console.log('| Lines | ' + total.lines.pct + '% | 80% | ' + (total.lines.pct >= 80 ? 'âœ…' : 'âŒ') + ' |');
          " >> $GITHUB_STEP_SUMMARY
        fi
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        directory: ./coverage/
        fail_ci_if_error: true
        
    - name: Upload coverage as artifact
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage/
        retention-days: 7
        
    - name: Comment PR with coverage
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('coverage/coverage-summary.json')) {
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const total = coverage.total;
            
            const comment = `## ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸
            
            | í•­ëª© | ì»¤ë²„ë¦¬ì§€ | ì„ê³„ê°’ | ìƒíƒœ |
            |------|----------|--------|------|
            | Statements | ${total.statements.pct}% | 80% | ${total.statements.pct >= 80 ? 'âœ…' : 'âŒ'} |
            | Branches | ${total.branches.pct}% | 80% | ${total.branches.pct >= 80 ? 'âœ…' : 'âŒ'} |
            | Functions | ${total.functions.pct}% | 80% | ${total.functions.pct >= 80 ? 'âœ…' : 'âŒ'} |
            | Lines | ${total.lines.pct}% | 80% | ${total.lines.pct >= 80 ? 'âœ…' : 'âŒ'} |
            
            ${total.statements.pct >= 80 && total.branches.pct >= 80 && total.functions.pct >= 80 && total.lines.pct >= 80 
              ? 'ğŸ‰ ëª¨ë“  ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ì„ ì¶©ì¡±í–ˆìŠµë‹ˆë‹¤!' 
              : 'âš ï¸ ì¼ë¶€ ì»¤ë²„ë¦¬ì§€ê°€ ì„ê³„ê°’ì— ë¯¸ë‹¬í–ˆìŠµë‹ˆë‹¤. ì¶”ê°€ í…ŒìŠ¤íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } 