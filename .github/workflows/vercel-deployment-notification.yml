name: Vercel Deployment Notification

on:
  push:
    branches: [main, production]
  workflow_dispatch:

jobs:
  notify-deployment-start:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Prepare commit message
        id: commit-msg
        run: |
          # ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          # ì¤„ë°”ê¿ˆì„ ê³µë°±ìœ¼ë¡œ ë³€í™˜í•˜ê³  íŠ¹ìˆ˜ ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
          SAFE_MSG=$(printf '%s' "$COMMIT_MSG" | tr '\n' ' ' | sed 's/"/\\"/g' | head -c 500)
          echo "safe_message=$SAFE_MSG" >> $GITHUB_OUTPUT
        
      - name: Send deployment start notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "ğŸš€ Picnic Web ë°°í¬ ì‹œì‘!",
              "attachments": [
                {
                  "color": "#ffaa00",
                  "fields": [
                    {
                      "title": "í™˜ê²½",
                      "value": "${{ github.ref_name == 'main' && 'Staging' || 'Production' }}",
                      "short": true
                    },
                    {
                      "title": "ë¸Œëœì¹˜",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "ì»¤ë°‹ ë©”ì‹œì§€",
                      "value": "${{ steps.commit-msg.outputs.safe_message }}",
                      "short": false
                    },
                    {
                      "title": "ì‘ì„±ì",
                      "value": "${{ github.event.head_commit.author.name }}",
                      "short": true
                    },
                    {
                      "title": "ì»¤ë°‹ SHA",
                      "value": "<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>",
                      "short": true
                    }
                  ],
                  "footer": "â³ Vercelì—ì„œ ë¹Œë“œ ì§„í–‰ ì¤‘..."
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify-deployment-success:
    runs-on: ubuntu-latest
    needs: notify-deployment-start
    if: success()
    steps:
      - name: Wait for deployment
        run: sleep 60
        
      - name: Prepare commit message
        id: commit-msg
        run: |
          # ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          # ì¤„ë°”ê¿ˆì„ ê³µë°±ìœ¼ë¡œ ë³€í™˜í•˜ê³  íŠ¹ìˆ˜ ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
          SAFE_MSG=$(printf '%s' "$COMMIT_MSG" | tr '\n' ' ' | sed 's/"/\\"/g' | head -c 500)
          echo "safe_message=$SAFE_MSG" >> $GITHUB_OUTPUT
        
      - name: Send deployment success notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "âœ… Picnic Web ë°°í¬ ì™„ë£Œ!",
              "attachments": [
                {
                  "color": "#36a64f",
                  "fields": [
                    {
                      "title": "í™˜ê²½",
                      "value": "${{ github.ref_name == 'main' && 'Staging' || 'Production' }}",
                      "short": true
                    },
                    {
                      "title": "ë°°í¬ URL",
                      "value": "${{ github.ref_name == 'main' && 'https://picnic-web-staging.vercel.app' || 'https://picnic-web-production.vercel.app' }}",
                      "short": true
                    },
                    {
                      "title": "ì»¤ë°‹ ë©”ì‹œì§€",
                      "value": "${{ steps.commit-msg.outputs.safe_message }}",
                      "short": false
                    },
                    {
                      "title": "ì‘ì„±ì",
                      "value": "${{ github.event.head_commit.author.name }}",
                      "short": true
                    },
                    {
                      "title": "ì»¤ë°‹ SHA",
                      "value": "<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>",
                      "short": true
                    }
                  ],
                  "footer": "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify-deployment-failure:
    runs-on: ubuntu-latest
    needs: notify-deployment-start
    if: failure()
    steps:
      - name: Prepare commit message
        id: commit-msg
        run: |
          # ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          # ì¤„ë°”ê¿ˆì„ ê³µë°±ìœ¼ë¡œ ë³€í™˜í•˜ê³  íŠ¹ìˆ˜ ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
          SAFE_MSG=$(printf '%s' "$COMMIT_MSG" | tr '\n' ' ' | sed 's/"/\\"/g' | head -c 500)
          echo "safe_message=$SAFE_MSG" >> $GITHUB_OUTPUT
        
      - name: Send deployment failure notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "âŒ Picnic Web ë°°í¬ ì‹¤íŒ¨!",
              "attachments": [
                {
                  "color": "#ff0000",
                  "fields": [
                    {
                      "title": "í™˜ê²½",
                      "value": "${{ github.ref_name == 'main' && 'Staging' || 'Production' }}",
                      "short": true
                    },
                    {
                      "title": "ë¸Œëœì¹˜",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "ì»¤ë°‹ ë©”ì‹œì§€",
                      "value": "${{ steps.commit-msg.outputs.safe_message }}",
                      "short": false
                    },
                    {
                      "title": "ì‘ì„±ì",
                      "value": "${{ github.event.head_commit.author.name }}",
                      "short": true
                    },
                    {
                      "title": "ì»¤ë°‹ SHA",
                      "value": "<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>",
                      "short": true
                    }
                  ],
                  "footer": "ğŸ”§ ë°°í¬ ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”."
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} 